@{
    ViewData["Title"] = "Quang Minh - Thống kê lỗi SX";

    string defaultStartDate = DateTime.Today.AddYears(-1).ToString("yyyy-MM-dd");
    string defaultEndDate = DateTime.Today.ToString("yyyy-MM-dd");
}

<div class="row">
    <div class="card p-3 w-100">
        <div class="d-flex justify-content-center">
            <div class="input-group" style="width: 200px;">
                <span class="input-group-text fw-bold" for="selectYear" style="background-color: #e9ecef;">
                    Chọn Năm:
                </span>
                <select id="selectYear" class="form-select">
                </select>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-6">
                <div class="grid-margin stretch-card">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title text-center fw-bold fs-3" id="errorChartTitle">Thống kê lỗi năm</h4>
                            <canvas id="errorChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="grid-margin stretch-card">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title text-center fw-bold fs-3" id="lineChartTitle">Thống kê lỗi theo NCC năm</h4>
                            <canvas id="errorLineChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="content-wrapper">
    <div class="row">
        <div class="col-lg-12 grid-margin stretch-card">
            <div class="card">
                <div class="card-body">
                    <h4 class="text-center text-4xl font-extrabold text-primary text-center mb-4">Danh sách lỗi sản xuất</h4>

                    <div class="row g-3 align-items-end mb-4">
                        <div class="col-md-4">
                            <label for="keySearch" class="form-label fw-bold">Tìm kiếm</label>
                            <input type="text" class="form-control" id="keySearch">
                        </div>
                        <div class="col-md-3">
                            <label for="startDate" class="form-label fw-bold">Từ ngày</label>
                            <input type="date" class="form-control" id="startDate" value="@defaultStartDate">
                        </div>
                        <div class="col-md-3">
                            <label for="endDate" class="form-label fw-bold">Đến ngày</label>
                            <input type="date" class="form-control" id="endDate" value="@defaultEndDate">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-primary w-100" id="searchBtn">
                                <i class="fas fa-search"></i>Tìm kiếm
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive overflow-auto" style="height: 1000px;">
                        <table class="table table-bordered table-striped table-hover" id="errorDataTable">
                            <thead class="text-white bg-dark" style="position: sticky; top: 0; z-index: 1;">
                                <tr>
                                    <th>STT</th>
                                    <th>Order</th>
                                    <th>Part Name</th>
                                    <th>Qty Order</th>
                                    <th class="text-danger">Qty NG</th>
                                    <th class="text-danger">Tỷ lệ NG</th>
                                    <th>Ngày /Tháng</th>
                                    <th>Phát hiện lỗi</th>
                                    <th>Dạng lỗi</th>
                                    <th>NCC</th>
                                    <th>NV mắc lỗi</th>
                                    <th>Bộ phận</th>
                                    <th>Ngày hoàn thành</th>
                                </tr>
                            </thead>
                            <tbody id="errorTableBody">
                            </tbody>
                        </table>
                        <p class="mt-3 text-secondary text-end">Tổng số lỗi: <span id="totalErrorsCount">0</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editModalLabel">Chi tiết báo cáo lỗi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="errorId" name="errorId">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="orderNo" class="form-label">Order</label>
                            <input type="text" class="form-control" id="orderNo" name="orderNo">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="partName" class="form-label">Part Name</label>
                            <input type="text" class="form-control" id="partName" name="partName">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="qtyOrder" class="form-label">Qty Order</label>
                            <input type="number" class="form-control" id="qtyOrder" name="qtyOrder">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="qtyNG" class="form-label">Qty NG</label>
                            <input type="number" class="form-control" id="qtyNG" name="qtyNG">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="dateMonth" class="form-label">Ngày /Tháng</label>
                            <input type="date" class="form-control" id="dateMonth" name="dateMonth">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="errorDetected" class="form-label">Phát hiện lỗi</label>
                            <input type="text" class="form-control" id="errorDetected" name="errorDetected">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="errorType" class="form-label">Dạng lỗi</label>
                            <input type="text" class="form-control" id="errorType" name="errorType">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="errorCause" class="form-label">Nguyên nhân lỗi</label>
                            <input type="text" class="form-control" id="errorCause" name="errorCause">
                        </div>
                        <div class="col-md-12 mb-3">
                            <label for="errorContent" class="form-label">Nội dung lỗi</label>
                            <textarea class="form-control" id="errorContent" name="errorContent" rows="3" spellcheck="false"></textarea>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="toleranceAssessment" class="form-label">Nhận định dung sai</label>
                            <input type="text" class="form-control" id="toleranceAssessment" name="toleranceAssessment">
                        </div>
                        <div class="col-md-12 mb-3">
                            <label for="reason" class="form-label">Nguyên nhân</label>
                            <textarea class="form-control" id="reason" name="reason" rows="3" spellcheck="false"></textarea>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label for="countermeasure" class="form-label">Đối sách</label>
                            <textarea class="form-control" id="countermeasure" name="countermeasure" rows="3" spellcheck="false"></textarea>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="ncc" class="form-label">NCC</label>
                            <input type="text" class="form-control" id="ncc" name="ncc">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="department" class="form-label">Bộ phận</label>
                            <input type="text" class="form-control" id="department" name="department">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="employeeCode" class="form-label">NV mắc lỗi</label>
                            <input type="text" class="form-control" id="employeeCode" name="employeeCode">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="errorCompletionDate" class="form-label">Ngày hoàn thành giấy báo lỗi</label>
                            <input type="date" class="form-control" id="errorCompletionDate" name="errorCompletionDate">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="remedialMeasures" class="form-label">Biện pháp khắc phục</label>
                            <input type="text" class="form-control" id="remedialMeasures" name="remedialMeasures">
                        </div>
                        <div class="col-md-12 mb-3">
                            <label for="note" class="form-label">Ghi chú</label>
                            <textarea class="form-control" id="note" name="note" rows="1" spellcheck="false"></textarea>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="timeWriteError" class="form-label">Thời gian viết giấy lỗi</label>
                            <input type="text" class="form-control" id="timeWriteError" name="timeWriteError">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="reviewNnds" class="form-label">Rà soát NNĐS</label>
                            <input type="text" class="form-control" id="reviewNnds" name="reviewNnds">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let errorChartInstance = null;
        let errorLineChartInstance = null;
        let currentErrorData = [];

        function formatDisplayDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date)) return '';
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        async function loadErrorTableData() {
            const key = $('#keySearch').val();
            const startDate = $('#startDate').val();
            const endDate = $('#endDate').val();
            const $tableBody = $('#errorTableBody');

            $tableBody.html('<tr><td colspan="13" class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Đang tải dữ liệu...</td></tr>');
            $('#totalErrorsCount').text('Đang tải...');

            try {
                const response = await fetch(`/DataError/GetDataErrors?key=${key}&startDate=${startDate}&endDate=${endDate}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                currentErrorData = result.data;
                $tableBody.empty();
                let stt = 1;
                let htmlContent = '';

                if (currentErrorData && currentErrorData.length > 0) {
                    currentErrorData.forEach(item => {
                        const ngRate = item.ngRate ? item.ngRate.toFixed(2) + '%' : '0.00%';
                        const dateMonthDisplay = formatDisplayDate(item.dateMonth);
                        const completionDateDisplay = formatDisplayDate(item.errorCompletionDate);

                        htmlContent += `<tr data-id="${item.id}">
                            <td>${stt++}</td>
                            <td class="text-wrap">${item.orderNo || ''}</td>
                            <td>${item.partName || ''}</td>
                            <td>${item.qtyOrder || 0}</td>
                            <td class="text-danger">${item.qtyNG || 0}</td>
                            <td class="text-danger">${ngRate}</td>
                            <td>${dateMonthDisplay}</td>
                            <td>${item.errorDetected || ''}</td>
                            <td>${item.errorType || ''}</td>
                            <td>${item.ncc || ''}</td>
                            <td>${item.employeeCode || ''}</td>
                            <td>${item.department || ''}</td>
                            <td>${completionDateDisplay}</td>
                        </tr>`;
                    });
                } else {
                    htmlContent = '<tr><td colspan="13" class="text-center">Không tìm thấy dữ liệu phù hợp.</td></tr>';
                }

                $tableBody.html(htmlContent);
                $('#totalErrorsCount').text(result.total);

            } catch (error) {
                console.error('Lỗi khi tải dữ liệu:', error);
                $tableBody.html('<tr><td colspan="13" class="text-center text-danger">Lỗi khi tải dữ liệu từ server. Vui lòng thử lại.</td></tr>');
                $('#totalErrorsCount').text('Lỗi');
            }
        }

        function drawErrorChart(labels, qmErrorsData, otherNccErrorsData, year) {
            const ctx = document.getElementById('errorChart').getContext('2d');
            const titleElement = document.getElementById('errorChartTitle');
            titleElement.textContent = `Thống kê lỗi năm ${year}`;

            const data = {
                labels: labels,
                datasets: [{
                    label: 'Lỗi của QM',
                    data: qmErrorsData,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }, {
                    label: 'Lỗi của NCC',
                    data: otherNccErrorsData,
                    backgroundColor: 'rgba(255, 99, 132, 0.5)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }]
            };

            if (errorChartInstance) {
                errorChartInstance.data = data;
                errorChartInstance.update();
            } else {
                errorChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: data,
                    options: {
                        responsive: true,
                        plugins: {
                        },
                        scales: {
                            x: { stacked: true, title: { display: true, text: 'Tháng' } },
                            y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Tổng số lỗi' } }
                        }
                    }
                });
            }
        }

        function drawErrorLineChart(chartData, year) {
            const ctx = document.getElementById('errorLineChart').getContext('2d');
            const titleElement = document.getElementById('lineChartTitle');
            titleElement.textContent = `Thống kê lỗi theo NCC năm ${year}`;

            const colors = [
                'rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)'
            ];

            chartData.datasets.forEach((dataset, index) => {
                dataset.borderColor = colors[index % colors.length];
                dataset.backgroundColor = colors[index % colors.length];
                dataset.hidden = true;
            });

            if (errorLineChartInstance) {
                errorLineChartInstance.data = chartData;
                errorLineChartInstance.update();
            } else {
                errorLineChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        plugins: {
                        },
                        scales: {
                            x: { title: { display: true, text: 'Tháng' } },
                            y: { beginAtZero: true, title: { display: true, text: 'Số lượng lỗi (QtyNG)' } }
                        }
                    }
                });
            }
        }

        function loadChartsByYear(year) {
            fetch(`/DataError/GetErrorChartData?year=${year}`)
                .then(response => {
                    if (!response.ok) throw new Error('Lỗi mạng hoặc server!');
                    return response.json();
                })
                .then(chartData => {
                    const labels = chartData.map(item => item.month);
                    const qmErrorsData = chartData.map(item => parseInt(item.qmErrors));
                    const otherNccErrorsData = chartData.map(item => parseInt(item.otherNccErrors));
                    drawErrorChart(labels, qmErrorsData, otherNccErrorsData, year);
                })
                .catch(error => {
                    console.error('Lỗi khi lấy dữ liệu Biểu đồ Cột:', error);
                });

            fetch(`/DataError/GetLineChartData?year=${year}`)
                .then(response => {
                    if (!response.ok) throw new Error('Lỗi mạng hoặc server!');
                    return response.json();
                })
                .then(chartData => {
                    drawErrorLineChart(chartData, year);
                })
                .catch(error => {
                    console.error('Lỗi khi lấy dữ liệu Biểu đồ Đường:', error);
                });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const selectYear = document.getElementById('selectYear');
            const currentYear = new Date().getFullYear();

            for (let year = currentYear; year >= 2020; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                selectYear.appendChild(option);
            }

            selectYear.addEventListener('change', function() {
                loadChartsByYear(this.value);
            });
            loadChartsByYear(currentYear);

            $('#searchBtn').on('click', function() {
                loadErrorTableData();
            });

            loadErrorTableData();

            $.contextMenu({
                selector: '#errorDataTable tbody tr',
                callback: function(key, options) {
                    const rowId = $(this).data('id');
                    const rowData = currentErrorData.find(item => item.id === rowId);

                    if (!rowData || !rowId) {
                        Swal.fire('Lỗi', 'Không tìm thấy dữ liệu hàng hoặc thiếu ID.', 'error');
                        return;
                    }

                    if (key === 'view') {
                        fetch(`/dataerror/getdetail/${rowId}`)
                            .then(response => {
                                if (!response.ok) throw new Error('Lỗi khi tải chi tiết.');
                                return response.json();
                            })
                            .then(data => {
                                $('#errorId').val(data.id);
                                $('#orderNo').val(data.orderNo);
                                $('#partName').val(data.partName);
                                $('#qtyOrder').val(data.qtyOrder);
                                $('#qtyNG').val(data.qtyNG);
                                $('#dateMonth').val(data.dateMonth ? new Date(data.dateMonth).toISOString().split('T')[0] : '');
                                $('#errorDetected').val(data.errorDetected);
                                $('#errorType').val(data.errorType);
                                $('#errorCause').val(data.errorCause);
                                $('#errorContent').val(data.errorContent);
                                $('#toleranceAssessment').val(data.toleranceAssessment);
                                $('#reason').val(data.reason);
                                $('#countermeasure').val(data.countermeasure);
                                $('#ncc').val(data.ncc);
                                $('#department').val(data.department);
                                $('#employeeCode').val(data.employeeCode);
                                $('#errorCompletionDate').val(data.errorCompletionDate ? new Date(data.errorCompletionDate).toISOString().split('T')[0] : '');
                                $('#remedialMeasures').val(data.remedialMeasures);
                                $('#note').val(data.note);
                                $('#timeWriteError').val(data.timeWriteError);
                                $('#reviewNnds').val(data.reviewNnds);

                                const editModal = new bootstrap.Modal(document.getElementById('editModal'));
                                editModal.show();
                            })
                            .catch(error => {
                                console.error('Lỗi khi tải chi tiết lỗi:', error);
                                Swal.fire('Lỗi', 'Không thể tải chi tiết lỗi.', 'error');
                            });
                    }
                },
                items: {
                    "view": { name: "Xem chi tiết", icon: "edit" },
                }
            });
        });
    </script>
}