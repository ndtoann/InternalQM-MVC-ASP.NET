@using Web_QM.Models
@using Web_QM.Models.ViewModels
@model Machine
@{
    ViewData["Title"] = $"Thông số máy - {Model.MachineName}";
    var machineImagePath = $"/imgs/machines/{Model.Picture}";
    string FormatValue(object? value, string unit = "")
    {
        if (value == null) return "N/A";
        if (value is decimal d) return d.ToString("N2") + " " + unit;
        if (value is int i) return i.ToString("N0") + " " + unit;
        return value.ToString() + " " + unit;
    }

    var latestTolerances = ViewBag.MachineTolerance as List<MachineToleranceDto> ?? new List<MachineToleranceDto>();
    var machineCode = Model.MachineCode;

    MachineToleranceDto GetTolerance(string type) => latestTolerances.FirstOrDefault(t => t.Type == type);

    string FormatDecimal(decimal? value) => value.HasValue ? $"{value.Value:N3}" : "N/A";
    string FormatDate(DateOnly? date) => date.HasValue ? date.Value.ToString("dd/MM/yyyy") : "";

    var types = new List<string> {
        "Độ chính xác",
        "Độ đảo trục chính",
        "Dung sai vị trí",
        "Độ song song",
        "Độ vuông góc"
    };
}

<div class="container py-4">
    <header class="bg-primary text-white p-4 rounded-3 shadow mb-4">
        <h1 class="display-4 fw-bold">@Model.MachineName</h1>
        <p class="lead">
            Mã máy: <span class="fw-light">@Model.MachineCode</span> 
            | Bộ phận: <span class="fw-light">@FormatValue(Model.Department)</span>
            | Trạng thái: <span class="fw-light">@FormatValue(Model.Status)</span>
        </p>
    </header>

    <div class="row">

        <div class="col-lg-5 mb-4">
            <div class="card shadow-lg h-100">
                <img src="@machineImagePath"
                     class="card-img-top p-3 machine-detail-img"
                     alt="@Model.MachineName"
                     onerror="this.onerror=null;this.src='/imgs/placeholder.png';">
                <div class="card-body">
                    <h5 class="card-title text-center text-primary fw-bold">Ảnh Thực Tế</h5>
                    <div class="text-center mt-3 d-flex flex-wrap justify-content-center gap-2">
                        <span class="badge bg-success-subtle text-success fs-6 p-2">Đời máy: @FormatValue(Model.Version)</span>
                        <span class="badge bg-success-subtle text-success fs-6 p-2">Đầu BT: @FormatValue(Model.BottleTaper)</span>
                        <span class="badge bg-success-subtle text-success fs-6 p-2">Số lượng trục: @FormatValue(Model.NumberOfAxes)</span>
                        <span class="badge bg-success-subtle text-success fs-6 p-2">Tốc Độ Trục Chính (Rpm): @FormatValue(Model.SpindleSpeed)</span>
                        <span class="badge bg-success-subtle text-success fs-6 p-2">Số lượng ổ dao: @FormatValue(Model.NumberOfKnifeSocket)</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-7 mb-4">
            <div class="card shadow-lg h-100">
                <div class="card-header bg-secondary text-white fw-bold fs-5">
                    THÔNG SỐ KỸ THUẬT CHÍNH
                </div>
                <div class="card-body p-4">
                    <div class="row g-3">

                        <div class="col-lg-6 col-sm-12">
                            <div class="card spec-item-card p-3 shadow-sm bg-light">
                                <small class="text-muted d-block fw-bold mb-2">Hành trình máy</small>
                                <div class="row g-2">
                                    <div class="col-4"><div class="spec-detail-group"><small class="text-muted d-block">X (mm)</small><span class="fw-bold text-dark fs-5">@FormatValue(Model.MachineJourneyX, "")</span></div></div>
                                    <div class="col-4"><div class="spec-detail-group"><small class="text-muted d-block">Y (mm)</small><span class="fw-bold text-dark fs-5">@FormatValue(Model.MachineJourneyY, "")</span></div></div>
                                    <div class="col-4"><div class="spec-detail-group"><small class="text-muted d-block">Z (mm)</small><span class="fw-bold text-dark fs-5">@FormatValue(Model.MachineJourneyZ, "")</span></div></div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6 col-sm-12">
                            <div class="card spec-item-card p-3 shadow-sm bg-light">
                                <small class="text-muted d-block fw-bold mb-2">Kích Thước Bàn Máy</small>
                                <div class="row g-2">
                                    <div class="col-6"><div class="spec-detail-group"><small class="text-muted d-block">X (mm)</small><span class="fw-bold text-dark fs-5">@FormatValue(Model.MachineTableSizeX, "")</span></div></div>
                                    <div class="col-6"><div class="spec-detail-group"><small class="text-muted d-block">Y (mm)</small><span class="fw-bold text-dark fs-5">@FormatValue(Model.MachineTableSizeY, "")</span></div></div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-12">
                            <div class="card spec-item-card p-3 shadow-sm bg-light">
                                <small class="text-muted d-block fw-bold mb-2">Hành trình chấu kẹp</small>
                                <div class="row g-3">
                                    <div class="col-lg-4 col-md-4 col-sm-12">
                                        <div class="spec-detail-group"><small class="text-muted d-block">Cặp ngoài X-max (mm)</small><span class="fw-bold text-dark fs-5">@FormatValue(Model.OuterPairX, "")</span></div>
                                        <div class="spec-detail-group mt-2"><small class="text-muted d-block">Cặp ngoài Z-max (mm)</small><span class="fw-bold text-dark fs-5">@FormatValue(Model.OuterPairZ, "")</span></div>
                                    </div>
                                    <div class="col-lg-4 col-md-4 col-sm-12">
                                        <div class="spec-detail-group"><small class="text-muted d-block">Cặp bung trong X-max (mm)</small><span class="fw-bold text-dark fs-5">@FormatValue(Model.PairInsideX, "")</span></div>
                                        <div class="spec-detail-group mt-2"><small class="text-muted d-block">Cặp bung trong Z-max (mm)</small><span class="fw-bold text-dark fs-5">@FormatValue(Model.PairInsideZ, "")</span></div>
                                    </div>
                                    <div class="col-lg-4 col-md-4 col-sm-12">
                                        <div class="spec-detail-group"><small class="text-muted d-block">Tiện chống tâm X-max (mm)</small><span class="fw-bold text-dark fs-5">@FormatValue(Model.TailstockX, "")</span></div>
                                        <div class="spec-detail-group mt-2"><small class="text-muted d-block">Tiện chống tâm Z-max (mm)</small><span class="fw-bold text-dark fs-5">@FormatValue(Model.TailstockZ, "")</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-12">
                            <div class="card spec-item-card p-3 shadow-sm bg-light">
                                <small class="text-muted d-block fw-bold mb-2">Dung sai máy</small>
                                <div class="row row-cols-md-5 row-cols-sm-3 row-cols-2 g-2">
                                    @foreach (var type in types)
                                    {
                                        var tolerance = GetTolerance(type);
                                        var parameter = tolerance?.LatestParameter;
                                        var hasData = parameter.HasValue;

                                        <div class="col">
                                            <div class="spec-detail-group
                                                     @(hasData ? "tolerance-history-link" : "")"
                                                 data-machine-code="@machineCode"
                                                 data-tolerance-type="@type"
                                                 data-bs-toggle="@(hasData ? "modal" : "")"
                                                 data-bs-target="@(hasData ? "#toleranceHistoryModal" : "")"
                                                 style="@(hasData ? "cursor: pointer;" : "")">

                                                <small class="text-muted d-block text-truncate">@type</small>

                                                <span class="fw-bold text-dark fs-5">
                                                    @FormatDecimal(parameter)
                                                </span>

                                                @if (hasData)
                                                {
                                                    <small class="text-primary d-block">(@FormatDate(tolerance.LatestDate))</small>
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <ul class="nav nav-tabs nav-justified" id="machineTabs" role="tablist">
                <li class="nav-item" role="presentation"><button class="nav-link active" id="repair-tab" data-bs-toggle="tab" data-bs-target="#repair" type="button" role="tab"><i class="fas fa-wrench me-1"></i> Lịch sử sửa chữa</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="maintenance-tab" data-bs-toggle="tab" data-bs-target="#maintenance" type="button" role="tab"><i class="fas fa-tools me-1"></i> Lịch bảo dưỡng</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab"><i class="fas fa-info-circle me-1"></i> Thông tin khác</button></li>
            </ul>

            <div class="tab-content border border-top-0 p-4 bg-white rounded-bottom shadow-sm">

                <div class="tab-pane fade show active" id="repair" role="tabpanel">
                    <div class="table-responsive">
                        <table id="repairTable"
                               class="table table-striped table-bordered table-hover"
                               data-toggle="table"
                               data-pagination="true"
                               data-search="true"
                               data-show-columns="true"
                               data-show-toggle="true"
                               data-sort-order="asc"
                               data-url="/machine/GetEquipmentRepair?machineCode=@Model.MachineCode"
                               data-data-field="data"
                               data-page-size="50"
                               data-click-to-select="true"
                               data-row-style="rowStyle"
                               data-height="1000">
                            <thead class="table-dark">
                                <tr>
                                    <th data-field="stt" data-width="50" data-formatter="sttFormatter">STT</th>
                                    <th data-field="errorCondition" data-sortable="true">Tình trạng lỗi hỏng</th>
                                    <th data-field="reason" data-sortable="true">Nguyên nhân</th>
                                    <th data-field="processingMethod" data-sortable="true">Phương pháp xử lý</th>
                                    <th data-field="dateMonth" data-sortable="true" data-formatter="dateFormatter">Ngày tiếp nhận</th>
                                    <th data-field="confirmCompletionDate" data-sortable="true" data-formatter="dateFormatter">BPBT xác nhận</th>
                                    <th data-field="completionDate" data-sortable="true" data-formatter="dateFormatter">Ngày hoàn thành</th>
                                    <th data-field="repairCosts" data-sortable="true">Chi phí</th>
                                    <th data-field="note">Ghi chú</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="maintenance" role="tabpanel">
                    <div class="table-responsive">
                        <table id="maintenanceTable"
                               class="table table-striped table-bordered table-hover"
                               data-toggle="table"
                               data-pagination="true"
                               data-search="true"
                               data-show-columns="true"
                               data-show-toggle="true"
                               data-sort-order="asc"
                               data-url="/machine/getMachineMaintenance?machineCode=@Model.MachineCode"
                               data-data-field="data"
                               data-page-size="50"
                               data-click-to-select="true"
                               data-row-style="rowStyleMaintenance"
                               data-height="1000">
                            <thead class="table-dark">
                                <tr>
                                    <th data-field="stt" data-width="50" data-formatter="sttFormatter">STT</th>
                                    <th data-field="dateMonth" data-sortable="true" data-formatter="dateFormatter">Ngày/Tháng</th>
                                    <th data-field="maintenanceStaff" data-sortable="true">Nhân viên bảo dưỡng</th>
                                    <th data-field="maintenanceContent" data-sortable="true">Nội dung bảo dưỡng</th>
                                    <th data-field="note">Ghi chú</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="info" role="tabpanel">
                    <h4 class="text-primary mb-3"><i class="fas fa-boxes me-2"></i> Kích Thước & Khối Lượng Máy</h4>
                    <div class="row g-3 mb-4">
                        <div class="col-md-4 col-sm-6"><div class="spec-detail-group"><small class="text-muted d-block">Chiều Rộng</small><span class="fw-bold text-dark fs-5">@FormatValue(Model.WideSize, "mm")</span></div></div>
                        <div class="col-md-4 col-sm-6"><div class="spec-detail-group"><small class="text-muted d-block">Chiều Sâu</small><span class="fw-bold text-dark fs-5">@FormatValue(Model.DeepSize, "mm")</span></div></div>
                        <div class="col-md-4 col-sm-6"><div class="spec-detail-group"><small class="text-muted d-block">Chiều Cao</small><span class="fw-bold text-dark fs-5">@FormatValue(Model.HighSize, "mm")</span></div></div>
                        <div class="col-md-4 col-sm-6"><div class="spec-detail-group"><small class="text-muted d-block">Trọng Lượng Máy</small><span class="fw-bold text-dark fs-5">@FormatValue(Model.Weight, "kg")</span></div></div>
                        <div class="col-md-4 col-sm-6"><div class="spec-detail-group"><small class="text-muted d-block">Công suất máy</small><span class="fw-bold text-dark fs-5">@FormatValue(Model.MachineCapacity, "kVA")</span></div></div>
                    </div>

                    <h4 class="text-primary mt-4 mb-3"><i class="fas fa-hand-holding-usd me-2"></i> Thông Tin Tài Chính & Khác</h4>
                    <p class="fs-4">
                        Giá trị ước tính:
                        <span class="fw-bold text-success">
                            @(Model.Price.HasValue? Model.Price.Value.ToString("N0") + " VNĐ" : "Chưa cập nhật")
                        </span>
                    </p>
                    <p class="fs-6"><i class="fas fa-map-marker-alt me-1 text-info"></i> Nơi đăng ký: <span class="fw-bold">@FormatValue(Model.Place)</span></p>


                    <h4 class="text-primary mt-4 mb-3"><i class="fas fa-clipboard-list me-2"></i> Ghi Chú & Lịch sử</h4>
                    <div class="alert alert-info">
                        <p class="mb-0">@(string.IsNullOrWhiteSpace(Model.Note) ? "Không có ghi chú đặc biệt." : Model.Note)</p>
                    </div>
                    <small class="text-muted d-block">
                        Ngày thêm máy: <span class="fw-semibold">@FormatValue(Model.CreatedDate)</span>
                    </small>
                    <small class="text-muted d-block">
                        Cập nhật gần nhất: <span class="fw-semibold">@FormatValue(Model.UpdatedDate)</span>
                    </small>
                </div>

            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="toleranceHistoryModal" tabindex="-1" aria-labelledby="toleranceHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="toleranceHistoryModalLabel">Lịch sử Dung sai: <span id="historyToleranceType"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Thông số</th>
                                <th>Ngày/Tháng</th>
                            </tr>
                        </thead>
                        <tbody id="toleranceHistoryTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function sttFormatter(value, row, index) {
            return index + 1;
        }

        function dateFormatter(value, row, index) {
            if (!value) {
                return '';
            }

            var date = new Date(value);
            var day = date.getDate().toString().padStart(2, '0');
            var month = (date.getMonth() + 1).toString().padStart(2, '0');
            var year = date.getFullYear();

            return `${day}/${month}/${year}`;
        }

        function rowStyle(row, index) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const dateMonthStr = row.dateMonth;
            const confirmDateStr = row.confirmCompletionDate;
            const completionDateStr = row.completionDate;

            const isCompleted = completionDateStr && completionDateStr !== "";

            if (isCompleted) {
                return {
                    classes: 'table-success'
                };
            }

            if (confirmDateStr && confirmDateStr !== "") {
                const confirmDate = new Date(confirmDateStr);
                confirmDate.setHours(0, 0, 0, 0);

                if (confirmDate < today) {
                    return {
                        classes: 'table-danger'
                    };
                }
            } else {
                const dateMonth = dateMonthStr ? new Date(dateMonthStr) : null;
                if (dateMonth) dateMonth.setHours(0, 0, 0, 0);

                if (dateMonth && dateMonth < today) {
                    return {
                        classes: 'table-warning'
                    };
                }
            }
            return {};
        }

        function rowStyleMaintenance(row, index) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dateMonth = new Date(row.dateMonth);
            dateMonth.setHours(0, 0, 0, 0);
            if (row.isComplete !== 1 && dateMonth < today) {
                return {
                    classes: 'table-danger'
                };
            }
            if (row.isComplete === 1) {
                return {
                    classes: 'table-success'
                };
            }
            return {};
        }

        $(document).ready(function() {
            $.extend($.fn.bootstrapTable.defaults, {
                formatRecordsPerPage: function (pageNumber) {
                    return ``;
                },
                formatShowingRows: function (pageFrom, pageTo, totalRows) {
                    return `Hiển thị từ ${pageFrom} đến ${pageTo} trên tổng số ${totalRows} hàng`;
                },
                formatSearch: function () {
                    return 'Tìm kiếm';
                },
                formatNoMatches: function () {
                    return 'Không tìm thấy dữ liệu phù hợp';
                }
            });

            $('#repairTable').bootstrapTable();
            $('#maintenanceTable').bootstrapTable();


            $('.tolerance-history-link').on('click', function (e) {
                if (!$(this).attr('data-bs-target')) return;

                const machineCode = $(this).data('machine-code');
                const toleranceType = $(this).data('tolerance-type');
                const tbody = $('#toleranceHistoryTableBody');
                const modalTitle = $('#historyToleranceType');

                modalTitle.text(toleranceType);
                tbody.html('<tr><td colspan="3" class="text-center"><div class="spinner-border spinner-border-sm me-2"></div>Đang tải lịch sử...</td></tr>');

                $.ajax({
                    url: '/machine/GetToleranceHistoryByType',
                    type: 'GET',
                    data: { machineCode: machineCode, type: toleranceType },
                    success: function (response) {
                        if (response.success && response.data.length > 0) {
                            renderHistoryTable(response.data, tbody);
                        } else {
                            tbody.html('<tr><td colspan="3" class="text-center text-muted">Không tìm thấy dữ liệu lịch sử.</td></tr>');
                        }
                    },
                    error: function () {
                        tbody.html('<tr><td colspan="3" class="text-center text-danger">Lỗi kết nối khi tải dữ liệu lịch sử.</td></tr>');
                    }
                });
            });

            function renderHistoryTable(data, tbody) {
                tbody.empty();
                let count = 1;
                data.forEach(item => {
                    let dateDisplay = 'N/A';
                    if (item.dateMonth) {
                        const dateObj = new Date(item.dateMonth);
                        if (!isNaN(dateObj.getTime())) {
                            dateDisplay = dateObj.toLocaleDateString('vi-VN', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric'
                            });
                        }
                    }
                    let parametersDisplay = item.parameters !== null && item.parameters !== undefined ? `${item.parameters.toFixed(3)}` : 'N/A';

                    const row = `
                        <tr>
                            <td>${count++}</td>
                            <td class="fw-bold">${parametersDisplay}</td>
                            <td>${dateDisplay}</td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            }
        });
    </script>
}