@{
    ViewData["Title"] = "Quang Minh";
}

<head>
    <link rel="stylesheet" href="~/css/home.css" asp-append-version="true" />
</head>

<div class="main-content-wrapper">
    <div class="container-fluid p-0">
        <div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-indicators">
                <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
                <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="1" aria-label="Slide 2"></button>
            </div>
            <div class="carousel-inner">
                <div class="carousel-item active">
                    <img src="~/imgs/slide-1.jpg" class="d-block w-100" alt="Hình ảnh 1">
                    <div class="carousel-caption d-none d-md-block">
                        <h5>Quang Minh</h5>
                        <p>...</p>
                    </div>
                </div>
                <div class="carousel-item">
                    <img src="~/imgs/slide-2.jpg" class="d-block w-100" alt="Hình ảnh 2">
                    <div class="carousel-caption d-none d-md-block">
                        <h5>Quang Minh</h5>
                        <p>...</p>
                    </div>
                </div>
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
            </button>
        </div>
    </div>
    <h3 class="text-center fs-4 fw-bold py-3">CÔNG TY TNHH SẢN XUẤT THƯƠNG MẠI QUANG MINH</h3>
    <div class="row p-lg-3 home-content py-5">
        <div class="col-lg-4">
            <a href="/testingsystem">
                <h5 class="title">Hệ thống kiểm tra</h5>
                <img src="~/imgs/bg-2.jpg" class="bg-content" />
            </a>
        </div>
        <div class="col-lg-4">
            <a href="/hr">
                <h5 class="title">Nhân sự</h5>
                <img src="~/imgs/bg-1.jpg" class="bg-content" />
            </a>
        </div>
        <div class="col-lg-4">
            <a href="/warehouse">
                <h5 class="title">Quản lý kho</h5>
                <img src="~/imgs/bg-3.jpg" class="bg-content" />
            </a>
        </div>
    </div>

    <div class="machine-intro-section">
        <div class="container">
            <h1>Công Nghệ Chính Xác Tối Tân</h1>
            <p>Hệ thống máy móc thế hệ mới, đáp ứng mọi yêu cầu gia công từ đơn giản đến phức tạp nhất.</p>
        </div>
    </div>

    <div class="seniority-container">
        <h4 class="text-center mt-5 fs-3 fw-bold">─── 🎖️ NHÂN VIÊN KỲ CỰU 🎖️ ───</h4>
        <div id="top-podium" class="podium-row"></div>
        <div id="bottom-list" class="others-row"></div>
    </div>

    <div class="seniority-milestone-section mt-20">
        <div class="container">
            <h4 class="text-center fs-3 fw-bold text-warning">─── VINH DANH 10 NĂM CỐNG HIẾN ───</h4>
            <div id="milestone-list" class="row justify-content-center mt-4"></div>
        </div>
    </div>

    <div class="cmt-form-container" data-aos="fade-up">
        <h2>Đóng góp ý kiến, báo lỗi phần mềm</h2>

        <form id="cmtForm" enctype="multipart/form-data">
            <div class="form-group">
                <select id="opinionType" class="form-control">
                    <option value="">-- Chọn loại ý kiến --</option>
                    <option value="Báo lỗi">Báo lỗi</option>
                    <option value="Góp ý">Góp ý</option>
                </select>
                <span class="error-message" style="display:none; color:red;">Vui lòng chọn loại ý kiến.</span>
            </div>

            <div class="form-group">
                <label>Tiêu đề</label>
                <input type="text" id="title" class="form-control" placeholder="Nhập tiêu đề...">
                <span class="error-message" style="display:none; color:red;">Vui lòng nhập tiêu đề.</span>
            </div>

            <div class="form-group">
                <label>Nội dung chi tiết</label>
                <textarea id="content" class="form-control" placeholder="Mô tả chi tiết..."></textarea>
                <span class="error-message" style="display:none; color:red;">Nội dung không được để trống.</span>
            </div>

            <div class="form-group">
                <label>Hình ảnh đính kèm (nếu có)</label>
                <input type="file" id="opinionImg" name="opinionImg" class="form-control" accept="image/*" />
            </div>

            <button type="submit" class="btn-submit">Xác nhận gửi</button>
        </form>
    </div>
</div>

<button id="chat-toggle-button" data-aos="fade-up">
    💬
</button>

<div id="chat-box">
    <div id="chat-header">
        <span id="chat-title">Hỗ trợ</span>
        <span id="chat-close-button">&times;</span>
    </div>
    <div id="chat-content">
        <div class="message bot-message">
            <p>
                Chào bạn, tôi có thể giúp gì cho bạn?
            </p>
        </div>
    </div>
    <div id="chat-input-container">
        <input type="text" id="user-input" placeholder="Nhập tin nhắn..." />
        <button id="send-button">Gửi</button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const chatToggleButton = document.getElementById('chat-toggle-button');
        const chatBox = document.getElementById('chat-box');
        const chatCloseButton = document.getElementById('chat-close-button');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const chatContent = document.getElementById('chat-content');

        function removeVietnameseMarks(str) {
            str = str.replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g, "a");
            str = str.replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ/g, "e");
            str = str.replace(/ì|í|ị|ỉ|ĩ/g, "i");
            str = str.replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ/g, "o");
            str = str.replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g, "u");
            str = str.replace(/ỳ|ý|ỵ|ỷ|ỹ/g, "y");
            str = str.replace(/đ/g, "d");
            str = str.replace(/\s/g, "");
            return str;
        }

        const responses = {
            'xinchao': 'Chào bạn :)',
            'hello': 'Chào bạn :)',
            'hi': 'Chào bạn :)',
            'quangminh': 'Công ty QUANG MINH là đơn vị hoạt động trong lĩnh vực Gia công cơ khí chính xác; Lắp đặt, bảo trì bảo dưỡng.',
            'thoigian': 'Thời gian làm việc từ 7h30p sáng đến 5h chiều, từ thứ Hai đến thứ Bảy.',
            'lienhe': 'Mọi thắc mắc vui lòng liên hệ phòng IT công ty Quang Minh.',
            'gioithieu': 'Đây là phần mềm quản lý dữ liệu nhân viên, đào tạo, các thống kê lỗi, làm bài kiểm tra...',
            'macdinh': 'Xin lỗi, tôi chưa hiểu yêu cầu của bạn. Xin vui lòng liên hệ trực tiếp phòng IT.',
            'loi': 'Bạn phát hiện lỗi hay sự cố nào đó, vui lòng liên hệ phòng IT.',
            'suco': 'Bạn phát hiện lỗi hay sự cố nào đó, vui lòng liên hệ phòng IT.'
        };

        function appendMessage(text, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            const p = document.createElement('p');
            p.textContent = text;
            messageDiv.appendChild(p);
            chatContent.appendChild(messageDiv);
            chatContent.scrollTop = chatContent.scrollHeight;
        }

        function sendMessage() {
            const userText = userInput.value.trim();
            if (userText === '') return;

            appendMessage(userText, 'user-message');

            const normalizedText = removeVietnameseMarks(userText.toLowerCase());
            let botResponse = responses.macdinh;

            setTimeout(() => {
                for (const keyword in responses) {
                    if (normalizedText.includes(keyword)) {
                        botResponse = responses[keyword];
                        break;
                    }
                }
                appendMessage(botResponse, 'bot-message');
            }, 500);

            userInput.value = '';
        }

        chatToggleButton.addEventListener('click', () => {
            chatBox.style.display = 'flex';
            chatToggleButton.style.display = 'none';
        });

        chatCloseButton.addEventListener('click', () => {
            chatBox.style.display = 'none';
            chatToggleButton.style.display = 'block';
        });

        sendButton.addEventListener('click', sendMessage);

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    });
</script>

@section Scripts {
    <script>
        $(document).ready(function () {
            $('#cmtForm').on('submit', function (e) {
                e.preventDefault();

                let isValid = true;
                const type = $('#opinionType').val();
                const title = $('#title').val().trim();
                const content = $('#content').val().trim();
                const fileInput = $('#opinionImg')[0].files[0];

                $('.error-message').hide();

                if (!type) {
                    $('#opinionType').siblings('.error-message').show();
                    isValid = false;
                }
                if (!title) {
                    $('#title').siblings('.error-message').show();
                    isValid = false;
                }
                if (!content) {
                    $('#content').siblings('.error-message').show();
                    isValid = false;
                }

                if (isValid) {
                    const formData = new FormData();
                    formData.append('Type', type);
                    formData.append('Title', title);
                    formData.append('Content', content);
                    if (fileInput) {
                        formData.append('ImageFile', fileInput);
                    }

                    $.ajax({
                        url: '/Home/SaveOpinion',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (res) {
                            if (res.success) {
                                Swal.fire("Thành công!", "Cảm ơn bạn đã đóng góp ý kiến!", "success");
                                $('#cmtForm')[0].reset();
                            }
                            else {
                                Swal.fire("Thất bại", "Đã có lỗi xảy ra trong quá trình gửi.", "error");
                            }
                        },
                        error: function () {
                            Swal.fire("Thất bại", "Đã có lỗi xảy ra trong quá trình gửi.", "error");
                        }
                    });
                }
            });
        });

        $(document).ready(function () {
            $.ajax({
                url: '/Home/GetTopSeniors',
                type: 'GET',
                success: function (data) {
                    let topHtml = '';
                    let bottomHtml = '';

                    data.forEach((emp, index) => {
                        let html = `
                            <div class="card ${index < 3 ? 'podium-item top-' + (index + 1) : 'other-item'}">
                                <img src="${emp.avatar}" alt="Avatar">
                                <span class="code">${emp.employeeCode} - ${emp.employeeName}</span>
                                <span class="tenure">${emp.tenure}</span>
                            </div>`;

                        if (index < 3) {
                            topHtml += html;
                        } else {
                            bottomHtml += html;
                        }
                    });

                    $('#top-podium').html(topHtml);
                    $('#bottom-list').html(bottomHtml);
                }
            });
        });

        document.addEventListener('DOMContentLoaded', function () {
            fetchMilestoneSeniors();
        });

        function fetchMilestoneSeniors() {
            $.ajax({
                url: '/Home/GetMilestoneSeniors',
                type: 'GET',
                success: function (data) {
                    let html = '';
                    if (data && data.length > 0) {
                        data.forEach(emp => {
                            html += `
                                <div class="col-6 col-md-4 col-lg-3 mb-4">
                                    <div class="card milestone-card text-center p-4 h-100">
                                        <div class="cup-animation">🏆</div>
                                        <img src="${emp.avatar || '/imgs/default-avatar.png'}" class="rounded-circle mx-auto avatar-milestone" alt="Avatar">
                                        <h5 class="mt-3 fw-bold text-dark mb-1">${emp.employeeName}</h5>
                                        <p class="text-muted small mb-2">${emp.employeeCode}</p>
                                        <div class="tenure-badge-10">
                                            ${emp.tenure}
                                        </div>
                                        <span class="year-marker">${emp.hireDate}</span>
                                    </div>
                                </div>`;
                        });
                        $('#milestone-list').html(html);
                    } else {
                        $('.seniority-milestone-section').hide();
                    }
                },
                error: function () {
                    $('.seniority-milestone-section').hide();
                }
            });
        }
    </script>
}