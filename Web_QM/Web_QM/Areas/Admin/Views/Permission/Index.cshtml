@using Web_QM.Models
@model IEnumerable<Permission>;
@{
    ViewData["Title"] = "Phân quyền";
}

<div class="content-wrapper">
    <div class="row">
        <div class="col-lg-12 grid-margin stretch-card">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">Danh sách các quyền</h4>
                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            @TempData["SuccessMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            @TempData["ErrorMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }
                    <a class="btn btn-success" href="~/admin/permission/add">Thêm mới</a>
                    <a class="btn btn-success" href="~/admin/accountPermission">Phân quyền cho nhân viên</a>
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered">
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>Mô tả</th>
                                    <th>Giá trị</th>
                                    <th>Phân luồng</th>
                                </tr>
                            </thead>
                            <tbody class="role-table-body">
                                @{
                                    var count = 1;
                                }
                                @foreach (var item in Model)
                                {
                                    <tr class="context-menu-row" data-id="@item.Id" data-description="@item.Description">
                                        <td>@(count++)</td>
                                        <td>@item.Description</td>
                                        <td>@item.ClaimValue</td>
                                        <td>@item.Module</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="contextMenu" class="dropdown-menu" style="position: absolute; display: none;">
    <a class="dropdown-item" href="#" id="editLink">Sửa</a>
    <a class="dropdown-item" href="#" id="deleteLink">Xóa</a>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tableBodies = document.querySelectorAll('.role-table-body');
            const contextMenu = document.getElementById('contextMenu');
            let roleId = null;
            let roleName = null;

            tableBodies.forEach(tableBody => {
                tableBody.addEventListener('contextmenu', function (event) {
                    const row = event.target.closest('tr');
                    if (!row) return;

                    event.preventDefault();

                    roleId = row.getAttribute('data-id');
                    roleName = row.getAttribute('data-description');

                    contextMenu.style.display = 'block';
                    contextMenu.style.left = event.pageX + 'px';
                    contextMenu.style.top = event.pageY + 'px';
                });
            });

            document.addEventListener('click', function (e) {
                if (!contextMenu.contains(e.target)) {
                    contextMenu.style.display = 'none';
                }
            });

            document.getElementById('editLink').addEventListener('click', function (event) {
                if (roleId) {
                    safeRedirect(`/admin/permission/edit?id=${roleId}`);
                }
            });

            document.getElementById('deleteLink').addEventListener('click', function (event) {
                if (roleId && confirm(`Bạn có chắc chắn muốn xóa phân quyền ${roleName}?`)) {
                    safeRedirect(`/admin/permission/delete?id=${roleId}`);
                }
            });
        });
    </script>
}