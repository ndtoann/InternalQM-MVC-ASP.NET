@using Web_QM.Models
@model IEnumerable<Kaizen>;
@{
    ViewData["Title"] = "Quản lý Kaizen";

    string defaultStartDate = DateTime.Today.AddYears(-5).ToString("yyyy-MM-dd");
    string defaultEndDate = DateTime.Today.ToString("yyyy-MM-dd");
    string startDateValue = ViewBag.StartDate ?? defaultStartDate;
    string endDateValue = ViewBag.EndDate ?? defaultEndDate;
}

<div class="content-wrapper">
    <div class="row">
        <div class="col-lg-12 grid-margin stretch-card">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">Danh sách kaizen</h4>
                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            @TempData["SuccessMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            @TempData["ErrorMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }
                    <form action="" method="get">
                        <div class="row align-items-center">
                            <div class="col-lg-2">
                                <div class="form-group mb-0">
                                    <select class="form-control" name="review" asp-items="@(ViewData["ReviewList"] as SelectList)"></select>
                                </div>
                            </div>
                            <div class="col-lg-2">
                                <div class="form-group mb-0">
                                    <input class="form-control" type="date" name="startDate" value="@startDateValue" />
                                </div>
                            </div>
                            <div class="col-lg-2">
                                <div class="form-group mb-0">
                                    <input class="form-control" type="date" name="endDate" value="@endDateValue" />
                                </div>
                            </div>
                            <div class="col-lg-5 d-flex align-items-center">
                                <div class="form-group me-2 flex-grow-1 mb-0">
                                    <input type="text"
                                           class="form-control"
                                           name="key"
                                           placeholder="Nhập vào đây để tìm kiếm"
                                           value="@ViewBag.KeySearch" />
                                </div>
                                <div class="form-group mb-0">
                                    <button type="submit" class="btn btn-primary">
                                        Tìm kiếm
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                    <a class="btn btn-success" href="~/admin/kaizen/add" asp-policy="AddKaizen">Thêm mới</a>
                    <a class="btn btn-success" href="#" data-bs-toggle="modal" data-bs-target="#importExcelModal" asp-policy="AddKaizen">Import Excel</a>
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered">
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>Ngày-Tháng</th>
                                    <th>Nhân viên</th>
                                    <th>Bộ phận</th>
                                    <th>BP áp dụng mở rộng Kaizen</th>
                                    <th>Mục tiêu cải tiến</th>
                                    <th>Tiêu đề cải tiến</th>
                                    <th>Tổ trưởng </th>
                                    <th>Ban quản lí đánh giá </th>
                                </tr>
                            </thead>
                            <tbody class="kaizen-table-body">
                                @{
                                    var count = 1;
                                }
                                @foreach (var item in Model)
                                {
                                    <tr class="context-menu-row"
                                        data-id="@item.Id"
                                        data-employee-name="@item.EmployeeCode - @item.EmployeeName"
                                        data-datemonth="@(item.DateMonth.ToString("yyyy-MM-dd"))"
                                        data-employeecode="@item.EmployeeCode"
                                        data-employeename="@item.EmployeeName"
                                        data-department="@item.Department"
                                        data-applieddepartment="@item.AppliedDepartment"
                                        data-improvementgoal="@item.ImprovementGoal"
                                        data-improvementtitle="@item.ImprovementTitle"
                                        data-currentsituation="@item.CurrentSituation"
                                        data-proposedidea="@item.ProposedIdea"
                                        data-estimatedbenefit="@item.EstimatedBenefit"
                                        data-teamleaderrating="@item.TeamLeaderRating"
                                        data-managementreview="@item.ManagementReview"
                                        data-picture="@item.Picture"
                                        data-deadline="@item.Deadline"
                                        data-starttime="@item.StartTime"
                                        data-currentstatus="@item.CurrentStatus"
                                        data-note="@item.Note">

                                        <td>@(count++)</td>
                                        <td>@(item.DateMonth.ToString("dd/MM/yyyy"))</td>
                                        <td>@item.EmployeeCode - @item.EmployeeName</td>
                                        <td>@item.Department</td>
                                        <td>@item.AppliedDepartment</td>
                                        <td>@item.ImprovementGoal</td>
                                        <td class="text-wrap">@item.ImprovementTitle</td>
                                        <td>@item.TeamLeaderRating</td>
                                        <td>@item.ManagementReview</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="contextMenu" class="dropdown-menu" style="position: absolute; display: none;">
    <a class="dropdown-item" href="#" id="detailLink">Xem chi tiết</a>
    <a class="dropdown-item" href="#" id="editLink">Sửa</a>
    <a class="dropdown-item" href="#" id="deleteLink">Xóa</a>
</div>

<div class="modal fade" id="kaizenDetailModal" tabindex="-1" aria-labelledby="kaizenDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="kaizenDetailModalLabel">CHI TIẾT KAIZEN: <span id="detail_ImprovementTitle_Badge" class="badge bg-light text-dark"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0 text-primary">Thông tin chung</h6>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0 fs-5">
                            <dt class="col-sm-3">Mã/Tên NV:</dt>
                            <dd class="col-sm-3"><span id="detail_EmployeeCode"></span> - <span id="detail_EmployeeName"></span></dd>

                            <dt class="col-sm-3">Ngày đề xuất:</dt>
                            <dd class="col-sm-3" id="detail_DateMonth"></dd>

                            <dt class="col-sm-3">Bộ phận đề xuất:</dt>
                            <dd class="col-sm-3" id="detail_Department"></dd>

                            <dt class="col-sm-3">BP áp dụng mở rộng:</dt>
                            <dd class="col-sm-3" id="detail_AppliedDepartment"></dd>
                        </dl>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0 text-primary">Nội dung cải tiến</h6>
                    </div>
                    <div class="card-body fs-5">
                        <h6 class="fw-bold fs-5">Mục tiêu cải tiến:</h6>
                        <p id="detail_ImprovementGoal" class="alert alert-info p-2 fs-5"></p>

                        <h6 class="fw-bold fs-5">Tình hình hiện tại:</h6>
                        <p id="detail_CurrentSituation" class="border p-2 fs-5"></p>

                        <h6 class="fw-bold text-success fs-5">Ý kiến cải tiến (Proposed Idea):</h6>
                        <p id="detail_ProposedIdea" class="alert alert-success p-2 fs-5"></p>

                        <h6 class="fw-bold fs-5">Hiệu quả lợi ích:</h6>
                        <p id="detail_EstimatedBenefit" class="border p-2 fs-5"></p>

                        <h6 class="fw-bold">Ảnh minh họa:</h6>
                        <div id="detail_Picture" class="mb-3">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0 text-primary">Đánh giá và Theo dõi</h6>
                    </div>
                    <div class="card-body">
                        <dl class="row fs-5">
                            <dt class="col-sm-3">Đánh giá Tổ trưởng:</dt>
                            <dd class="col-sm-3"><span id="detail_TeamLeaderRating"></span></dd>

                            <dt class="col-sm-3">Đánh giá BQL:</dt>
                            <dd class="col-sm-3"><span id="detail_ManagementReview"></span></dd>

                            <dt class="col-sm-3">Thời gian bắt đầu:</dt>
                            <dd class="col-sm-3" id="detail_StartTime"></dd>

                            <dt class="col-sm-3">Thời hạn hoàn thành:</dt>
                            <dd class="col-sm-3" id="detail_Deadline"></dd>

                            <dt class="col-sm-3">Trạng thái hiện tại:</dt>
                            <dd class="col-sm-9"><span id="detail_CurrentStatus" class="badge bg-success"></span></dd>

                            <dt class="col-sm-3">Ghi chú:</dt>
                            <dd class="col-sm-9" id="detail_Note"></dd>
                        </dl>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="importExcelModal" tabindex="-1" aria-labelledby="importExcelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importExcelModalLabel">Import Dữ liệu Kaizen từ Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="importForm" method="post" enctype="multipart/form-data">
                <div class="modal-body">
                    <div id="import-alert" class="alert d-none" role="alert"></div>

                    <div class="mb-3">
                        <label for="excelFile" class="form-label">Chọn File Excel (.xlsx, .xls)</label>
                        <input class="form-control" type="file" id="excelFile" name="excelFile" accept=".xlsx, .xls" required>
                    </div>

                    <p>
                        Vui lòng đảm bảo dùng đúng file excel mẫu.
                    </p>
                    <a href="~/admin/kaizen/DownloadTemplate" class="btn btn-sm btn-info" download>
                        <i class="mdi mdi-download"></i> Tải file mẫu Import
                    </a>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-primary" id="btnImport">
                        <span id="spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        <span id="btnText">Thực hiện Import</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const IMAGE_BASE_PATH = '/imgs/kaizens/';

        document.addEventListener('DOMContentLoaded', function () {
            const tableBodies = document.querySelectorAll('.kaizen-table-body');
            const contextMenu = document.getElementById('contextMenu');
            let kaizenId = null;
            let employeeName = null;
            let currentRow = null;
            let detailModal = new bootstrap.Modal(document.getElementById('kaizenDetailModal'));

            tableBodies.forEach(tableBody => {
                tableBody.addEventListener('contextmenu', function (event) {
                    const row = event.target.closest('tr');
                    if (!row) return;

                    event.preventDefault();

                    currentRow = row;
                    kaizenId = row.getAttribute('data-id');
                    employeeName = row.getAttribute('data-employee-name');

                    contextMenu.style.display = 'block';
                    contextMenu.style.left = event.pageX + 'px';
                    contextMenu.style.top = event.pageY + 'px';
                });
            });

            document.addEventListener('click', function (e) {
                if (!contextMenu.contains(e.target)) {
                    contextMenu.style.display = 'none';
                }
            });

            document.getElementById('contextMenu').addEventListener('click', function (e) {
                 if (e.target.classList.contains('dropdown-item')) {
                     contextMenu.style.display = 'none';
                 }
            });

            document.getElementById('detailLink').addEventListener('click', function (event) {
                event.preventDefault();
                if (currentRow) {
                    const data = extractDataFromRow(currentRow);
                    fillModalWithData(data);
                    detailModal.show();
                } else {
                    alert('Không tìm thấy dữ liệu chi tiết Kaizen.');
                }
            });

            document.getElementById('editLink').addEventListener('click', function (event) {
                event.preventDefault();
                if (kaizenId) {
                    window.location.href = `/admin/kaizen/edit?id=${kaizenId}`;
                }
            });

            document.getElementById('deleteLink').addEventListener('click', function (event) {
                event.preventDefault();
                if (kaizenId && confirm(`Bạn có chắc chắn muốn xóa kaizen của ${employeeName}?`)) {
                    window.location.href = `/admin/kaizen/delete?id=${kaizenId}`;
                }
            });

            function extractDataFromRow(row) {
                return {
                    Id: row.getAttribute('data-id'),
                    DateMonth: row.getAttribute('data-datemonth'),
                    EmployeeCode: row.getAttribute('data-employeecode'),
                    EmployeeName: row.getAttribute('data-employeename'),
                    Department: row.getAttribute('data-department'),
                    AppliedDepartment: row.getAttribute('data-applieddepartment'),
                    ImprovementGoal: row.getAttribute('data-improvementgoal'),
                    ImprovementTitle: row.getAttribute('data-improvementtitle'),
                    CurrentSituation: row.getAttribute('data-currentsituation'),
                    ProposedIdea: row.getAttribute('data-proposedidea'),
                    EstimatedBenefit: row.getAttribute('data-estimatedbenefit'),
                    TeamLeaderRating: row.getAttribute('data-teamleaderrating'),
                    ManagementReview: row.getAttribute('data-managementreview'),
                    Picture: row.getAttribute('data-picture'),
                    Deadline: row.getAttribute('data-deadline'),
                    StartTime: row.getAttribute('data-starttime'),
                    CurrentStatus: row.getAttribute('data-currentstatus'),
                    Note: row.getAttribute('data-note')
                };
            }

            function fillModalWithData(data) {
                const formatDate = (dateString) => {
                    if (!dateString) return '';
                    try {
                        const date = new Date(dateString);
                        if (isNaN(date.getTime())) return dateString;
                        return date.toLocaleDateString('vi-VN');
                    } catch (e) {
                        return dateString;
                    }
                };

                document.getElementById('kaizenDetailModalLabel').querySelector('span').innerText = data.ImprovementTitle ?? '';

                document.getElementById('detail_DateMonth').innerText = formatDate(data.DateMonth) ?? '';

                const empContainer = document.querySelector('.modal-body .card:first-child dd:nth-child(2)');
                empContainer.innerHTML = `<span id="detail_EmployeeCode">${data.EmployeeCode ?? ''}</span> - <span id="detail_EmployeeName">${data.EmployeeName ?? ''}</span>`;

                document.getElementById('detail_Department').innerText = data.Department ?? '';
                document.getElementById('detail_AppliedDepartment').innerText = data.AppliedDepartment ?? '';

                document.getElementById('detail_ImprovementGoal').innerText = data.ImprovementGoal ?? '';
                document.getElementById('detail_CurrentSituation').innerText = data.CurrentSituation ?? '';
                document.getElementById('detail_ProposedIdea').innerText = data.ProposedIdea ?? '';
                document.getElementById('detail_EstimatedBenefit').innerText = data.EstimatedBenefit ?? '';

                document.getElementById('detail_TeamLeaderRating').innerText = data.TeamLeaderRating ?? '';
                document.getElementById('detail_ManagementReview').innerText = data.ManagementReview ?? '';
                document.getElementById('detail_Deadline').innerText = data.Deadline ?? '';
                document.getElementById('detail_StartTime').innerText = data.StartTime ?? '';
                document.getElementById('detail_CurrentStatus').innerText = data.CurrentStatus ?? '';
                document.getElementById('detail_Note').innerText = data.Note ?? '';

                const pictureElement = document.getElementById('detail_Picture');
                if (data.Picture && data.Picture.trim()) {
                    const pictureFileName = data.Picture.trim();
                    const pictureUrl = `${IMAGE_BASE_PATH}${pictureFileName}`;

                    pictureElement.innerHTML = `<a href="${pictureUrl}" target="_blank"><img src="${pictureUrl}" class="img-fluid rounded shadow-sm" alt="Ảnh Kaizen" style="max-width: 500px; height: auto; display: block; margin-top: 10px;"></a>`;
                } else {
                    pictureElement.innerText = 'Không có ảnh';
                }
            }

            // xử lý import data
            const importForm = document.getElementById('importForm');
            const btnImport = document.getElementById('btnImport');
            const btnText = document.getElementById('btnText');
            const spinner = document.getElementById('spinner');
            const importModal = new bootstrap.Modal(document.getElementById('importExcelModal'));

            importForm.addEventListener('submit', function (e) {
                e.preventDefault();

                const file = document.getElementById('excelFile').files[0];
                if (!file) {
                    Swal.fire('Thao tác thất bại', 'Vui lòng chọn một file Excel để import.', 'warning');
                    return;
                }

                btnImport.disabled = true;
                btnText.textContent = 'Đang xử lý...';
                spinner.classList.remove('d-none');

                const formData = new FormData(importForm);

                fetch('/admin/kaizen/import', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 400 || response.status === 500) {
                        return response.json().then(errorData => {
                            throw new Error(errorData.message);
                        });
                    }
                    throw new Error('Lỗi không xác định: ' + response.statusText);
                })
                .then(data => {
                    importModal.hide();
                    Swal.fire({
                        title: 'Import Thành công! 🎉',
                        html: data.message,
                        icon: 'success',
                        confirmButtonText: 'Đã hiểu'
                    }).then(() => {
                        location.reload();
                    });
                })
                .catch(error => {
                    importModal.hide();
                    console.error('Lỗi khi Import:', error);

                    Swal.fire({
                        title: 'Import Thất bại! ❌',
                        html: error.message,
                        icon: 'error',
                        confirmButtonText: 'Đóng'
                    }).then(() => {
                         importModal.show();
                    });
                })
                .finally(() => {
                    btnImport.disabled = false;
                    btnText.textContent = 'Thực hiện Import';
                    spinner.classList.add('d-none');
                });
            });
        });
    </script>
}