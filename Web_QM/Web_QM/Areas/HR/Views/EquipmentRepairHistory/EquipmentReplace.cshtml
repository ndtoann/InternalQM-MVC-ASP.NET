@{
    ViewData["Title"] = "Danh sách Vật tư Thay thế";
}

<div class="content-wrapper">
    <div class="row">
        <div class="col-lg-12 grid-margin stretch-card">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title text-primary">Danh sách Vật tư Thay thế</h4>

                    <div class="mb-4 p-3 bg-light border rounded">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-5">
                                <label for="searchItem" class="form-label">Tìm kiếm Vật tư/Thiết bị</label>
                                <input type="text" class="form-control" id="searchItem" placeholder="Nhập tên vật tư hoặc thiết bị...">
                            </div>

                            <div class="col-md-2">
                                <button id="btnSearch" class="btn btn-primary w-100">
                                    <i class="fas fa-search"></i> Tìm kiếm
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table id="replacementTable" class="table table-bordered table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>STT</th>
                                    <th>Vật tư/Thiết bị Thay thế</th>
                                    <th>Thiết bị Sửa chữa</th>
                                    <th>Ngày Sửa chữa</th>
                                    <th>File PDF</th>
                                </tr>
                            </thead>
                            <tbody id="replacementTableBody">
                            </tbody>
                        </table>
                        <div id="loadingMessage" class="text-center p-3 text-muted"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="pdfEmbedModal" tabindex="-1" aria-labelledby="pdfEmbedModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="pdfEmbedModalLabel">File PDF: <span id="pdf-file-name-embed" class="text-primary"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="height: 80vh;">
                <div id="pdfEmbedContainer" style="width: 100%; height: 100%;">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const API_URL = '/hr/EquipmentRepairHistory/GetReplacementDetails';
        const $tableBody = $('#replacementTableBody');
        const $loadingMessage = $('#loadingMessage');
        const $searchItemInput = $('#searchItem');
        const $btnSearch = $('#btnSearch');

        function loadReplacementData() {
            $tableBody.empty();
            $loadingMessage.text('Đang tải dữ liệu...').show();

            const searchKeyword = $searchItemInput.val();

            const requestParams = {
                searchItem: searchKeyword
            };

            $.ajax({
                url: API_URL,
                type: 'GET',
                dataType: 'json',
                data: requestParams,
                success: function(data) {
                    $loadingMessage.hide();

                    const listData = data || [];

                    if (listData.length === 0) {
                        $loadingMessage.text('Không tìm thấy dữ liệu phù hợp.').show();
                        return;
                    }

                    let htmlRows = '';
                    const pdfUrlBase = '/files/equipments/';

                    listData.forEach((item, index) => {
                        const date = new Date(item.dateMonth);
                        const formattedDate = date.toLocaleDateString('vi-VN');

                        let fileLink;
                        if (item.filePdf) {
                            const fullPdfUrl = pdfUrlBase + item.filePdf;
                            const pdfName = item.equipmentAndlSupplies;

                            fileLink = `
                                <a href="#"
                                   class="view-pdf-embed text-primary"
                                   data-pdf-url="${fullPdfUrl}"
                                   data-pdf-name="${pdfName}">
                                   Xem File
                                </a>
                            `;
                        } else {
                            fileLink = 'Không có';
                        }

                        htmlRows += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${item.equipmentAndlSupplies || ''}</td>
                                <td>${item.equipmentName || ''} ${item.equipmentCode ? ' - ' + item.equipmentCode : ''}</td>
                                <td>${formattedDate}</td>
                                <td>${fileLink}</td>
                            </tr>
                        `;
                    });

                    $tableBody.html(htmlRows);
                },
                error: function() {
                    $loadingMessage.text('Lỗi khi tải dữ liệu. Vui lòng kiểm tra API.').show();
                }
            });
        }

        $(document).on('click', '.view-pdf-embed', function (event) {
            event.preventDefault();

            const pdfUrl = $(this).data('pdf-url');
            const pdfName = $(this).data('pdf-name');
            const embedContainer = document.getElementById('pdfEmbedContainer');
            const modalElement = document.getElementById('pdfEmbedModal');
            const modal = new bootstrap.Modal(modalElement);

            $('#pdf-file-name-embed').text(pdfName);

            if (embedContainer && pdfUrl) {
                $(embedContainer).empty();

                const embedElement = document.createElement('embed');
                embedElement.src = pdfUrl;
                embedElement.type = 'application/pdf';
                embedElement.width = '100%';
                embedElement.height = '100%';

                embedContainer.appendChild(embedElement);

                modal.show();
            }
        });

        $('#pdfEmbedModal').on('hidden.bs.modal', function () {
            $('#pdfEmbedContainer').empty();
            $('#pdf-file-name-embed').text('');
        });

        $(document).ready(function() {
            $btnSearch.on('click', function(e) {
                e.preventDefault();
                loadReplacementData();
            });

            $searchItemInput.on('keypress', function(e) {
                if (e.which === 13) {
                    e.preventDefault();
                    loadReplacementData();
                }
            });

            loadReplacementData();
        });
    </script>
}