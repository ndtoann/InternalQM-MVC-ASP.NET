@model Web_QM.Models.ViewModels.ExamTrainingDetailView
@{
    ViewData["Title"] = "Chi tiết bài kiểm tra";
}

<div class="content-wrapper">
    <div class="row">
        <div class="col-lg-12 grid-margin stretch-card">
            <div class="card">
                <div class="card-body">
                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            @TempData["SuccessMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            @TempData["ErrorMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }
                    <div>
                        <h2 class="text-center">@Model.exam.ExamName</h2>
                        <p class="text-center text-danger">Thời gian làm: @Model.exam.DurationMinute phút</p>
                        <div class="row border border-4 p-3">
                            <div class="col-lg-3">
                                <a href="~/hr/examtraining/addquestion?examid=@Model.exam.Id" class="btn btn-success">Thêm câu hỏi mới</a>
                            </div>
                            <div class="col-lg-9">
                                <p>
                                    <a class="btn btn-primary" data-bs-toggle="collapse" href="#collapseImportForm" role="button" aria-expanded="false" aria-controls="collapseImportForm">
                                        Import câu hỏi từ Excel
                                    </a>
                                </p>
                                <div class="collapse" id="collapseImportForm">
                                    <div class="card card-body">
                                        <form id="importForm" method="post" enctype="multipart/form-data">
                                            <div class="form-group mt-3">
                                                <label for="file">Chọn file Excel để import</label>
                                                <input type="file" name="file" id="file" class="form-control" />
                                                <a href="~/hr/examtraining/DownloadTemplate" class="btn btn-secondary">Tải file Excel mẫu</a>
                                                <button type="submit" class="btn btn-primary">Import Dữ Liệu</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    @{
                        var countQuestion = Model.questions.Count;
                    }
                    @for (int i = 0; i < countQuestion; i++)
                    {
                        var item = Model.questions[i];
                        <div class="question" data-question-id="@item.Id" data-current-order="@item.DisplayOrder">
                            <div class="d-flex py-3">
                                <div class="d-flex align-items-center">
                                    <button class="btn btn-sm btn-outline-secondary me-1 sort-btn" data-id="@item.Id" data-direction="up" @(i == 0 ? "disabled" : "")><i class="mdi mdi-arrow-up-bold"></i></button>
                                    <button class="btn btn-sm btn-outline-secondary sort-btn" data-id="@item.Id" data-direction="down" @(i == countQuestion - 1 ? "disabled" : "")><i class="mdi mdi-arrow-down-bold"></i></button>
                                </div>
                                <a href="~/hr/examtraining/editquestion?id=@item.Id" class="btn btn-sm btn-info"><i>Sửa</i></a>
                                <a href="#" onclick="if(confirm('Xác nhận xóa câu hỏi này?') == true){ window.location.href = `/hr/examtraining/deletequestion?id=@item.Id`; }" class="btn btn-sm btn-danger"><i>Xóa</i></a>
                                <div class="d-flex align-items-center ms-2">
                                    <select id="correctOption-@item.Id" asp-for="@item.CorrectOption" class="form-select form-select-sm" style="width: auto;">
                                        <option value="A">A</option>
                                        <option value="B">B</option>
                                        <option value="C">C</option>
                                        <option value="D">D</option>
                                    </select>
                                    <button class="btn btn-sm btn-success ms-2 save-correct-option" data-id="@item.Id">Lưu</button>
                                </div>
                                <div class="d-flex align-items-center ms-2">
                                    <select class="form-select form-select-sm target-question-select" style="width: auto;">
                                        <option value="">-- Di chuyển đến vị trí --</option>
                                        @foreach (var otherQuestion in Model.questions)
                                        {
                                            if (otherQuestion.Id != item.Id)
                                            {
                                                <option value="@otherQuestion.Id">Đổi chỗ câu @(Model.questions.IndexOf(otherQuestion) + 1)</option>
                                            }
                                        }
                                    </select>
                                    <button class="btn btn-sm btn-primary move-btn" data-id="@item.Id">Di chuyển</button>
                                </div>
                            </div>
                            <div class="text-xl md:text-xl font-extrabold text-wrap fw-bold fs-5">
                                <span class="question-number">Câu @(i + 1)/@countQuestion:</span>
                                <div class="text-center">
                                    @Html.Raw(item.QuestionText)
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-6 answer @(item.CorrectOption == "A" ? "badge-success fw-bold" : "")">A. @Html.Raw(item.OptionA)</div>
                                <div class="col-lg-6 answer @(item.CorrectOption == "B" ? "badge-success fw-bold" : "")">B. @Html.Raw(item.OptionB)</div>
                                <div class="col-lg-6 answer @(item.CorrectOption == "C" ? "badge-success fw-bold" : "")">C. @Html.Raw(item.OptionC)</div>
                                <div class="col-lg-6 answer @(item.CorrectOption == "D" ? "badge-success fw-bold" : "")">D. @Html.Raw(item.OptionD)</div>
                            </div>
                        </div>
                    }
                    <div class="p-5">
                        <h4>Câu hỏi tự luận</h4>
                        <div class="fw-bold fs-3">
                            <embed src="/files/essay_questions/@Model.exam.EssayQuestion#toolbar=0&navpanes=0&view=FitH"
                                   type="application/pdf" 
                                   height="1000px"
                                   width="100%"/>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            $('#importForm').on('submit', function (e) {
                e.preventDefault();
                var fileInput = $('#file')[0].files[0];
                if (!fileInput) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Chưa chọn file',
                        text: 'Vui lòng chọn một file Excel để import!',
                    });
                    return;
                }

                var formData = new FormData(this);

                formData.append('examId', @Model.exam.Id);
        
                var url = '@Url.Action("ImportExcelQuestion", "ExamTraining", new { area = "hr" })';

                $.ajax({
                    url: url,
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Thành công!',
                            text: response.message || 'Dữ liệu đã được import thành công.',
                            confirmButtonText: 'OK'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                location.reload();
                            }
                        });
                    },
                    error: function (xhr, status, error) {
                        var errorMessage = "Có lỗi xảy ra khi xử lý yêu cầu.";
                        try {
                            var errorResponse = JSON.parse(xhr.responseText);
                            errorMessage = errorResponse.message;
                        } catch (e) {
                        }

                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi Import!',
                            html: `<p>${errorMessage}</p>`,
                            confirmButtonText: 'Đóng'
                        });
                    }
                });
            });

            $(document).on('click', '.save-correct-option', function(e) {
                e.preventDefault();

                var questionId = $(this).data('id');
                var newCorrectOption = $(`#correctOption-${questionId}`).val();
                var questionContainer = $(this).closest('.question');
                var answerDivs = questionContainer.find('.answer');

                $.ajax({
                    url: '@Url.Action("UpdateCorrectOption", "ExamTraining", new { area = "hr" })',
                    type: 'POST',
                    data: {
                        id: questionId,
                        correctOption: newCorrectOption
                    },
                    success: function(response) {
                        if (response.success) {
                            answerDivs.removeClass('badge-success fw-bold');
                            var newCorrectDiv = answerDivs.filter(function() {
                                var option = $(this).text().trim().charAt(0);
                                return option === newCorrectOption;
                            });

                            newCorrectDiv.addClass('badge-success fw-bold');

                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Lỗi!',
                                text: response.message || 'Có lỗi xảy ra khi cập nhật đáp án.',
                            });
                        }
                    },
                    error: function(xhr, status, error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi!',
                            text: 'Không thể kết nối đến máy chủ. Vui lòng thử lại sau.',
                        });
                    }
                });
            });

            // Xử lý sự kiện khi nhấn nút sắp xếp lên/xuống
            $(document).on('click', '.sort-btn', function(e) {
                e.preventDefault();

                var button = $(this);
                var questionContainer = button.closest('.question');
                var questionId = questionContainer.data('question-id');
                var direction = button.data('direction');

                var targetQuestion;
                if (direction === 'up') {
                    targetQuestion = questionContainer.prev('.question');
                } else {
                    targetQuestion = questionContainer.next('.question');
                }

                if (targetQuestion.length === 0) {
                    return;
                }
                $.ajax({
                    url: '@Url.Action("UpdateQuestionOrder", "ExamTraining", new { area = "hr" })',
                    type: 'POST',
                    data: {
                        questionId: questionId,
                        direction: direction
                    },
                    success: function(response) {
                        if (response.success) {
                            if (direction === 'up') {
                                questionContainer.insertBefore(targetQuestion);
                            } else {
                                questionContainer.insertAfter(targetQuestion);
                            }

                            Swal.fire({
                                icon: 'success',
                                title: 'Thành công!',
                                text: response.message,
                                showConfirmButton: false,
                                timer: 1500
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Lỗi!',
                                text: response.message || 'Có lỗi xảy ra khi cập nhật thứ tự.',
                            });
                        }
                    },
                    error: function(xhr, status, error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi!',
                            text: 'Không thể kết nối đến máy chủ. Vui lòng thử lại sau.',
                        });
                    }
                });
            });

            //di chuyển câu hỏi
            $(document).on('click', '.move-btn', function(e) {
                e.preventDefault();
                var currentQuestionId = $(this).data('id');
                var targetQuestionId = $(this).siblings('.target-question-select').val();

                if (!targetQuestionId) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Chưa chọn vị trí',
                        text: 'Vui lòng chọn một câu hỏi để di chuyển đến.',
                    });
                    return;
                }

                $.ajax({
                    url: '@Url.Action("UpdateQuestionPosition", "ExamTraining", new { area = "hr" })',
                    type: 'POST',
                    data: {
                        questionId: currentQuestionId,
                        targetQuestionId: targetQuestionId
                    },
                    success: function(response) {
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Thành công!',
                                text: response.message,
                                showConfirmButton: false,
                                timer: 1500
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Lỗi!',
                                text: response.message,
                            });
                        }
                    },
                    error: function() {
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi!',
                            text: 'Không thể kết nối đến máy chủ. Vui lòng thử lại sau.',
                        });
                    }
                });
            });
        });
    </script>
}